const remSize=parseInt(getComputedStyle(document.documentElement).fontSize),gamePanel=document.getElementById("gamePanel"),playPanel=document.getElementById("playPanel"),infoPanel=document.getElementById("infoPanel"),countPanel=document.getElementById("countPanel"),scorePanel=document.getElementById("scorePanel"),aaOuter=document.getElementById("aaOuter"),startButton=document.getElementById("startButton"),romaNode=document.getElementById("roma"),gradeOption=document.getElementById("gradeOption"),aa=document.getElementById("aa"),tmpCanvas=document.createElement("canvas"),alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZ",gameTime=60;let playing,countdowning,typeTimer;const bgm=new Audio("mp3/bgm.mp3");bgm.volume=.3,bgm.loop=!0;let typeIndex=0,errorCount=0,normalCount=0,solveCount=0,guide=!0;const layout109={default:["q w e r t y u i o p","a s d f g h j k l ;","z x c v b n m , ."],shift:["Q W E R T Y U I O P","A S D F G H J K L +","Z X C V B N M < >"]},simpleKeyboard=new SimpleKeyboard.default({layout:layout109,onKeyPress:e=>{typeEventKey(e)}}),audioContext=new AudioContext,audioBufferCache={};loadAudio("end","mp3/end.mp3"),loadAudio("keyboard","mp3/keyboard.mp3"),loadAudio("correct","mp3/correct.mp3"),loadAudio("incorrect","mp3/cat.mp3");let englishVoices=[];loadVoices(),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark"),localStorage.getItem("bgm")!=1&&(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"))}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function toggleBGM(){localStorage.getItem("bgm")==1?(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"),localStorage.setItem("bgm",0),bgm.pause()):(document.getElementById("bgmOn").classList.remove("d-none"),document.getElementById("bgmOff").classList.add("d-none"),localStorage.setItem("bgm",1),bgm.play())}function toggleKeyboard(){const e=document.getElementById("virtualKeyboardOn"),t=document.getElementById("virtualKeyboardOff");e.classList.contains("d-none")?(e.classList.remove("d-none"),t.classList.add("d-none"),document.getElementById("keyboard").classList.remove("d-none"),resizeFontSize(aa)):(e.classList.add("d-none"),t.classList.remove("d-none"),document.getElementById("keyboard").classList.add("d-none"),document.getElementById("guideSwitch").checked=!1,guide=!1,resizeFontSize(aa))}function toggleGuide(e){e.target.checked?guide=!0:guide=!1}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}function loadVoices(){const e=new Promise(e=>{let t=speechSynthesis.getVoices();if(t.length!==0)e(t);else{let n=!1;speechSynthesis.addEventListener("voiceschanged",()=>{n=!0,t=speechSynthesis.getVoices(),e(t)}),setTimeout(()=>{n||document.getElementById("noTTS").classList.remove("d-none")},1e3)}}),t=["com.apple.speech.synthesis.voice.Bahh","com.apple.speech.synthesis.voice.Albert","com.apple.speech.synthesis.voice.Hysterical","com.apple.speech.synthesis.voice.Organ","com.apple.speech.synthesis.voice.Cellos","com.apple.speech.synthesis.voice.Zarvox","com.apple.speech.synthesis.voice.Bells","com.apple.speech.synthesis.voice.Trinoids","com.apple.speech.synthesis.voice.Boing","com.apple.speech.synthesis.voice.Whisper","com.apple.speech.synthesis.voice.Deranged","com.apple.speech.synthesis.voice.GoodNews","com.apple.speech.synthesis.voice.BadNews","com.apple.speech.synthesis.voice.Bubbles"];e.then(e=>{englishVoices=e.filter(e=>e.lang=="en-US").filter(e=>!t.includes(e.voiceURI))})}function loopVoice(e,t){speechSynthesis.cancel();const n=new SpeechSynthesisUtterance(e);n.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)],n.lang="en-US";for(let e=0;e<t;e++)speechSynthesis.speak(n)}function typeNormal(e){e.style.visibility="visible",playAudio("keyboard"),e.classList.add("typed"),typeIndex+=1,normalCount+=1}function underlineSpace(e){e.textContent==" "&&e.style.removeProperty("text-decoration");const t=e.nextElementSibling;t&&t.textContent==" "&&(t.style.textDecoration="underline")}function nextProblem(){playAudio("correct",.3),typeIndex=0,solveCount+=1,typable()}function removeGuide(e){const n=e.previousSiblingElement;if(n){let e=n.textContent;gradeOption.selectedIndex==0?e=e.toUpperCase():e=e.toLowerCase();const t=simpleKeyboard.getButtonElement(e);t.classList.remove("guide")}let t=e.textContent;gradeOption.selectedIndex==1?t=t.toUpperCase():t=t.toLowerCase(),t==" "&&(t="{space}");const s=simpleKeyboard.getButtonElement(t);s&&s.classList.remove("guide")}function showGuide(e){if(guide){let t=e.textContent;gradeOption.selectedIndex==1?t=t.toUpperCase():t=t.toLowerCase();const n=simpleKeyboard.getButtonElement(t);n&&n.classList.add("guide")}}function typeEvent(e){switch(e.code){case"Space":e.preventDefault();default:return typeEventKey(e.key)}}function typeEventKey(e){switch(e){case"Escape":replay();return;case" ":if(!playing){replay();return}}const t=romaNode.childNodes[typeIndex];/^[^0-9]$/.test(e)&&(e.toLowerCase()==t.textContent.toLowerCase()?(typeNormal(t),removeGuide(t),underlineSpace(t)):(playAudio("incorrect",.3),errorCount+=1),typeIndex==romaNode.childNodes.length?nextProblem():showGuide(romaNode.childNodes[typeIndex]))}function resizeFontSize(e){function h(e,t){const n=tmpCanvas.getContext("2d");n.font=t;const s=n.measureText(e);return s.width}function f(e,t,n,s){const o=e.split(`
`),a=t+"px "+n;let i=0;for(let e=0;e<o.length;e++){const t=h(o[e],a);i<t&&(i=t)}return[i,t*o.length*s]}function m(e){const t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),n=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom);return[t,n]}const n=getComputedStyle(e),c=n.fontFamily,t=parseFloat(n.fontSize),l=parseFloat(n.lineHeight)/t,d=aaOuter.offsetHeight,u=infoPanel.clientWidth,i=[u,d],a=f(e.textContent,t,c,l),r=m(n),o=t*(i[0]-r[0])/a[0]*.9,s=t*(i[1]-r[1])/a[1]*.9;s<o?s<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=s+"px":o<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=o+"px"}function typable(){let e;if(gradeOption.selectedIndex>=2?e=alphabet[solveCount]:e=alphabet[solveCount],solveCount>=26)speechSynthesis.cancel(),clearInterval(typeTimer),bgm.pause(),playAudio("end"),scoring();else{aa.textContent=e+" "+e.toLowerCase();const t=e;for(loopVoice(t.toLowerCase(),10);romaNode.firstChild;)romaNode.removeChild(romaNode.firstChild);for(let e=0;e<t.length;e++){const n=document.createElement("span");n.textContent=t[e],romaNode.appendChild(n)}resizeFontSize(aa),showGuide(romaNode.childNodes[0])}}function countdown(){if(countdowning)return;countdowning=!0,typeIndex=normalCount=errorCount=solveCount=0,document.getElementById("guideSwitch").disabled=!0,document.getElementById("virtualKeyboard").disabled=!0,gamePanel.classList.add("d-none"),countPanel.classList.remove("d-none"),counter.textContent=3;const e=setInterval(()=>{const t=document.getElementById("counter"),n=["skyblue","greenyellow","violet","tomato"];if(parseInt(t.textContent)>1){const e=parseInt(t.textContent)-1;t.style.backgroundColor=n[e],t.textContent=e}else countdowning=!1,playing=!0,clearInterval(e),document.getElementById("guideSwitch").disabled=!1,document.getElementById("virtualKeyboard").disabled=!1,gamePanel.classList.remove("d-none"),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),playPanel.classList.remove("d-none"),aaOuter.classList.remove("d-none"),scorePanel.classList.add("d-none"),resizeFontSize(aa),typable(),startTypeTimer(),localStorage.getItem("bgm")==1&&bgm.play(),startButton.disabled=!1},1e3)}function replay(){clearInterval(typeTimer),removeGuide(romaNode.childNodes[typeIndex]),initTime(),countdown(),countPanel.classList.remove("d-none"),scorePanel.classList.add("d-none")}function startTypeTimer(){const e=document.getElementById("time");typeTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(typeTimer),bgm.pause(),playAudio("end"),scoring())},1e3)}function initTime(){document.getElementById("time").textContent=gameTime}gradeOption.addEventListener("change",()=>{initTime(),clearInterval(typeTimer)});function scoring(){playing=!1,infoPanel.classList.remove("d-none"),playPanel.classList.add("d-none"),aaOuter.classList.add("d-none"),countPanel.classList.add("d-none"),scorePanel.classList.remove("d-none");let e=parseInt(document.getElementById("time").textContent);e<gameTime&&(e=gameTime-e);const t=(normalCount/e).toFixed(2);document.getElementById("totalType").textContent=normalCount+errorCount,document.getElementById("typeSpeed").textContent=t,document.getElementById("errorType").textContent=errorCount}function changeGrade(){const e=gradeOption.selectedIndex;e==0?simpleKeyboard.setOptions({layoutName:"default"}):simpleKeyboard.setOptions({layoutName:"shift"})}resizeFontSize(aa),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toggleBGM").onclick=toggleBGM,document.getElementById("virtualKeyboard").onclick=toggleKeyboard,window.addEventListener("resize",()=>{resizeFontSize(aa)}),document.getElementById("gradeOption").onchange=changeGrade,document.getElementById("guideSwitch").onchange=toggleGuide,startButton.addEventListener("click",replay),document.addEventListener("keydown",typeEvent),document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})